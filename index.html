<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pig Catcher - Desert</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<style>
body { margin:0; background: #ddd; }
canvas { display:block; margin:0 auto; }
</style>
</head>
<body>

<script>
let gameStarted = false;
let pigs, box, scoreText, highText, missText;
let score = 0, misses = 0;
let highScore = localStorage.getItem('pigHighScore') || 0;
const MAX_MISSES = 15;
let spawnTimer;

const config = {
  type: Phaser.CANVAS,
  width: window.innerWidth,
  height: window.innerHeight,
  physics: { default: 'arcade', arcade: { gravity: { y: 200 }, debug: false } },
  scene: { preload, create, update }
};

new Phaser.Game(config);

function preload() {
  this.load.image('bg', 'assets/IMG_2835.jpeg');    // desert background
  this.load.image('box', 'assets/IMG_2837.jpeg');   // cup / box
  this.load.image('pig', 'assets/IMG_2836.jpeg');   // pig falling object
}

function create() {
  const w = this.scale.width;
  const h = this.scale.height;

  // Background
  this.add.image(w/2, h/2, 'bg').setDisplaySize(w, h);

  // Start screen
  const title = this.add.text(w/2, h/2 - 80, 'PIG CATCHER', { font: '48px Arial', fill: '#000' }).setOrigin(0.5);
  const tapText = this.add.text(w/2, h/2, 'Tap to Play', { font: '28px Arial', fill: '#000' }).setOrigin(0.5);

  this.input.once('pointerdown', () => {
    title.destroy();
    tapText.destroy();
    startGame.call(this);
  });
}

function startGame() {
  gameStarted = true;
  score = 0;
  misses = 0;

  const w = this.scale.width;
  const h = this.scale.height;

  // Score displays
  scoreText = this.add.text(20,20,'Score: 0',{ font:'24px Arial', fill:'#000' });
  highText = this.add.text(20,50,'High: ' + highScore,{ font:'20px Arial', fill:'#000' });
  missText = this.add.text(20,80,'Misses: 0 / ' + MAX_MISSES,{ font:'20px Arial', fill:'#aa0000' });

  // Cup / box
  box = this.physics.add.staticImage(w/2, h - 140, 'box').setScale(1.5).refreshBody();

  // Pigs group
  pigs = this.physics.add.group();

  spawnTimer = this.time.addEvent({
    delay: 1000,
    loop: true,
    callback: () => spawnPig.call(this)
  });

  // Catch detection
  this.physics.add.overlap(pigs, box, catchPig, null, this);

  // Enable dragging pigs
  this.input.on('gameobjectdown', (pointer, gameObject) => {
    if (gameObject.texture.key === 'pig') {
      gameObject.setData('dragging', true);
      gameObject.body.setAllowGravity(false);
    }
  });

  this.input.on('gameobjectup', (pointer, gameObject) => {
    if (gameObject.texture.key === 'pig') {
      gameObject.setData('dragging', false);
      gameObject.body.setAllowGravity(true);
    }
  });

  this.input.on('pointermove', pointer => {
    pigs.getChildren().forEach(pig => {
      if (pig.getData('dragging')) {
        pig.x = pointer.x;
        pig.y = pointer.y;
      }
    });
  });
}

function spawnPig() {
  const w = this.scale.width;
  const h = this.scale.height;

  // Spawn within width of cup
  const boxWidth = box.displayWidth;
  const x = Phaser.Math.Between(box.x - boxWidth/2 + 20, box.x + boxWidth/2 - 20);

  const pig = pigs.create(x, -50, 'pig').setScale(0.1); // small pigs
  pig.body.setCollideWorldBounds(true);
  pig.body.setBounce(0);
}

function catchPig(pig, box) {
  if (!pig.active) return;
  pig.destroy();
  score++;
  scoreText.setText('Score: ' + score);

  if (score > highScore) {
    highScore = score;
    localStorage.setItem('pigHighScore', highScore);
    highText.setText('High: ' + highScore);

    const text = this.add.text(this.scale.width/2,150,'NEW HIGH SCORE!',{font:'32px Arial',fill:'#ffdd00'}).setOrigin(0.5);
    this.tweens.add({ targets:text, y:100, alpha:0, duration:1200, onComplete:()=>text.destroy() });
  }
}

function update() {
  // Count missed pigs
  pigs.getChildren().forEach(pig => {
    if (pig.y > this.scale.height) {
      pig.destroy();
      misses++;
      missText.setText('Misses: ' + misses + ' / ' + MAX_MISSES);
      if (misses >= MAX_MISSES) gameOver.call(this);
    }
  });
}

function gameOver() {
  spawnTimer.remove(false);
  pigs.clear(true,true);
  const w = this.scale.width;
  const h = this.scale.height;
  this.add.rectangle(w/2,h/2,w,h,0x000000,0.6);
  this.add.text(w/2,h/2 - 40,'GAME OVER',{font:'48px Arial',fill:'#fff'}).setOrigin(0.5);
  this.add.text(w/2,h/2 + 20,'Tap to Restart',{font:'24px Arial',fill:'#fff'}).setOrigin(0.5)
      .once('pointerdown',()=>location.reload());
}
</script>

</body>
</html>
