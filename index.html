<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ice Capture</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<style>
body { margin:0; background: #87CEFA; }
canvas { display:block; margin:0 auto; }
</style>
</head>
<body>

<script>
let gameStarted = false;
let iceGroup, catchZone, scoreText, highText, missText;
let score = 0;
let misses = 0;
let highScore = localStorage.getItem('iceHighScore') || 0;
let grabbed = null, rope, spawnTimer;

const MAX_MISSES = 15;

const config = {
  type: Phaser.CANVAS,
  width: window.innerWidth,
  height: window.innerHeight,
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 200 }, debug: false }
  },
  scene: { preload, create, update }
};

new Phaser.Game(config);

function preload() {
  this.load.image('bgSky','https://upload.wikimedia.org/wikipedia/commons/3/3c/Sky_-_Blue_-_Clouds.jpg'); // simple sky
  this.load.image('cup','https://upload.wikimedia.org/wikipedia/commons/3/32/Cartoon_jail_cell.png'); // cup/jail
  this.load.image('ice','https://upload.wikimedia.org/wikipedia/commons/3/3b/Ice_cube.png'); // ice cube
}

function create() {
  const w = this.scale.width;
  const h = this.scale.height;

  this.add.image(w/2, h/2, 'bgSky').setDisplaySize(w,h);

  const title = this.add.text(w/2, h/2 - 80, 'ICE CAPTURE', {
    font: '48px Arial',
    fill: '#003366'
  }).setOrigin(0.5);

  const tapText = this.add.text(w/2, h/2, 'Tap to Play', {
    font: '28px Arial',
    fill: '#003366'
  }).setOrigin(0.5);

  this.input.once('pointerdown', () => {
    title.destroy();
    tapText.destroy();
    startGame.call(this);
  });
}

function startGame() {
  gameStarted = true;
  score = 0;
  misses = 0;

  const w = this.scale.width;
  const h = this.scale.height;

  scoreText = this.add.text(20,20,'Score: 0',{ font:'24px Arial', fill:'#000' });
  highText = this.add.text(20,50,'High: ' + highScore,{ font:'20px Arial', fill:'#000' });
  missText = this.add.text(20,80,'Misses: 0 / ' + MAX_MISSES,{ font:'20px Arial', fill:'#aa0000' });

  // Big cup
  const cup = this.add.image(w/2, h-150, 'cup').setScale(1.5);
  cup.setOrigin(0.5,0);

  // Catch zone (smaller than cup for skill)
  catchZone = this.add.rectangle(
    w/2,
    h - 60,
    120,
    30,
    0xff0000,
    0
  );
  this.physics.add.existing(catchZone, true);

  iceGroup = this.physics.add.group();

  spawnTimer = this.time.addEvent({
    delay: 1000,
    loop: true,
    callback: () => spawnIce.call(this)
  });

  rope = this.add.graphics();

  this.input.on('pointerdown', p => {
    iceGroup.children.iterate(ice => {
      if (!ice || !ice.active) return;
      if (Phaser.Math.Distance.Between(p.x,p.y,ice.x,ice.y) < 50) {
        grabbed = ice;
        ice.grabbed = true;
        ice.body.setAllowGravity(false);
        ice.body.setVelocity(0);
      }
    });
  });

  this.input.on('pointerup', () => {
    if (grabbed) {
      grabbed.body.setAllowGravity(true);
      grabbed = null;
    }
  });

  this.physics.add.overlap(iceGroup, catchZone, (zone, ice) => {
    if (!ice.active || !ice.grabbed) return;

    ice.disableBody(true, true);
    score++;
    scoreText.setText('Score: ' + score);

    if (score > highScore) {
      highScore = score;
      localStorage.setItem('iceHighScore', highScore);
      highText.setText('High: ' + highScore);

      const text = this.add.text(this.scale.width/2,150,'NEW HIGH SCORE!',{font:'32px Arial',fill:'#ffdd00'}).setOrigin(0.5);
      this.tweens.add({
        targets:text, y:100, alpha:0, duration:1200,
        onComplete:()=>text.destroy()
      });
    }
  });
}

function spawnIce() {
  const w = this.scale.width;

  const ice = iceGroup.create(
    Phaser.Math.Between(w/2 - 200, w/2 + 200),
    -60,
    'ice'
  );
  ice.setScale(0.8);
  ice.grabbed = false;

  ice.body.setCollideWorldBounds(true);
  ice.body.onWorldBounds = true;

  ice.body.world.on('worldbounds', body => {
    if (body.gameObject === ice && ice.active) {
      ice.disableBody(true, true);
      misses++;
      missText.setText('Misses: ' + misses + ' / ' + MAX_MISSES);
      if (misses >= MAX_MISSES) {
        spawnTimer.remove(false);
        iceGroup.clear(true,true);
        this.add.rectangle(this.scale.width/2,this.scale.height/2,this.scale.width,this.scale.height,0x000000,0.6);
        this.add.text(this.scale.width/2,this.scale.height/2 - 40,'GAME OVER',{font:'48px Arial',fill:'#fff'}).setOrigin(0.5);
        this.add.text(this.scale.width/2,this.scale.height/2 + 20,'Tap to Restart',{font:'24px Arial',fill:'#fff'}).setOrigin(0.5)
          .once('pointerdown',()=>location.reload());
      }
    }
  });
}

function update() {
  if (!gameStarted) return;

  rope.clear();
  if (grabbed) {
    grabbed.setPosition(this.input.x, this.input.y);
    rope.lineStyle(3,0x00ffff);
    rope.beginPath();
    rope.moveTo(this.input.x,this.input.y);
    rope.lineTo(grabbed.x,grabbed.y);
    rope.strokePath();
  }
}
</script>

</body>
</html>
